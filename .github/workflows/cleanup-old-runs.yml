name: Cleanup Old Workflow Runs

on:
  schedule:
    - cron: '0 2 * * *' # T√§glich um 2:00 Uhr
  workflow_dispatch:
    inputs:
      days:
        description: 'L√∂sche Runs, die √§lter sind als X Tage'
        required: true
        default: '1'
      minimum_runs:
        description: 'Behalte mindestens X Runs pro Workflow'
        required: true
        default: '2'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: üóëÔ∏è Alte Workflow Runs l√∂schen
        uses: actions/github-script@v7
        with:
          script: |
            const days = parseInt('${{ github.event.inputs.days || 1 }}');
            const minRuns = parseInt('${{ github.event.inputs.minimum_runs || 2 }}');
            console.log(`L√∂sche Runs √§lter als ${days} Tage, behalte min. ${minRuns} Runs.`);
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const now = Date.now();
            
            // Hole alle Workflows
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner,
              repo,
            });
            
            console.log(`Gefunden: ${workflows.data.total_count} Workflows.`);

            for (const workflow of workflows.data.workflows) {
              console.log(`Pr√ºfe Workflow: ${workflow.name} (${workflow.id})`);
              
              // Hole Runs f√ºr diesen Workflow (sortiert nach neueste zuerst)
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                per_page: 100, // Max 100 pro Batch
              });
              
              // Sortierung ist bereits 'neueste zuerst'
              let keptCount = 0;
              let deletedCount = 0;
              
              // Iteriere durch Runs (neueste zuerst)
              for (const run of runs.data.workflow_runs) {
                const ageMs = now - new Date(run.created_at).getTime();
                const ageDays = ageMs / (1000 * 60 * 60 * 24);
                
                // Logik zum Behalten:
                // Behalte immer die ersten 'minRuns' (die neuesten)
                if (keptCount < minRuns) {
                  keptCount++;
                  continue;
                }
                
                // Wenn nicht unter den Top N, dann auf Alter pr√ºfen
                if (ageDays <= days) {
                   // Run ist zwar nicht Top N, aber noch jung genug -> Behalten
                   continue;
                }
                
                // L√∂sche Run
                console.log(`L√∂schen: Run ${run.id} (#${run.run_number}) vom ${run.created_at} (${ageDays.toFixed(1)} Tage alt)`);
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id,
                  });
                  deletedCount++;
                } catch (e) {
                  console.log(`Fehler beim L√∂schen von Run ${run.id}: ${e.message}`);
                }
              }
              console.log(`Workflow ${workflow.name}: ${deletedCount} gel√∂scht.`);
            }
